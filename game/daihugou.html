<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å¯Œè±ªã‚²ãƒ¼ãƒ </title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            color: #333;
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin: 15px 0;
            color: #4b0082;
        }
        
        .game-area {
            position: relative;
            min-height: 80vh;
            background-color: #e6ffe6;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .play-area {
            background-color: #009688;
            padding: 15px;
            border-radius: 10px;
            height: 200px; /* é«˜ã•ã‚’å¢—ã‚„ã—ã¦ã€ã‚«ãƒ¼ãƒ‰ãŒã¯ã¿å‡ºãªã„ã‚ˆã†ã«ã—ã¾ã—ãŸ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .player {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 5px 10px;
            text-align: center;
            width: 24%;
            position: relative;
        }
        
        .current-player {
            background-color: #ffeb3b;
            box-shadow: 0 0 10px #ffeb3b;
        }
        
        .played-cards {
    display: flex;
    justify-content: center;
    min-height: 80px;
    margin-top: 15px; /* ã“ã®è¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ */
}   
        
        .player-hand {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
            min-height: 160px;
        }
        
        .card {
            width: 50px;
            height: 75px;
            margin: 3px;
            background-color: white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
            overflow: hidden;
        }
        
        .card.selected {
            transform: translateY(-15px);
            box-shadow: 0 0 10px gold;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card.selected:hover {
            transform: translateY(-15px);
        }
        
        .rank {
            font-size: 14px;
            font-weight: bold;
            padding: 3px;
        }
        
        .suit {
            font-size: 20px;
            text-align: center;
        }
        
        .card.heart, .card.diamond {
            color: #ff0000;
        }
        
        .card.spade, .card.club {
            color: #000;
        }
        
        .card .center-img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover {
            background-color: #45a049;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .pass-btn {
            background-color: #ff9800;
        }
        
        .pass-btn:hover {
            background-color: #e68a00;
        }
        
        .status-message {
    background-color: rgba(255, 255, 255, 0.8);
    padding: 8px;
    border-radius: 5px;
    text-align: center;
    margin-top: 10px;
    min-height: 36px;
    /* è¿½åŠ ã—ãŸéƒ¨åˆ†: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã„å ´åˆã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
    word-break: break-word;
    overflow-wrap: break-word;
    line-height: 1.3;
}
        
        .computer-hand {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        
        .revolution-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ff5252;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .revolution-active {
            opacity: 1;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 15px;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .game-over.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .results {
            margin: 20px 0;
        }
        
        .results div {
            margin: 5px 0;
            font-size: 18px;
        }
        
        .restart-btn {
            background-color: #f44336;
            padding: 10px 20px;
            font-size: 18px;
        }
        
        .restart-btn:hover {
            background-color: #d32f2f;
        }
        
        @media (max-width: 600px) {
            .card {
                width: 40px;
                height: 60px;
                margin: 2px;
            }
            
            .rank {
                font-size: 12px;
            }
            
            .suit {
                font-size: 16px;
            }
            
            .card .center-img {
                font-size: 18px;
            }
            
            .play-area {
                height: 160px; /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã‚‚é©åˆ‡ãªé«˜ã•ã‚’ç¢ºä¿ */
            }
            
            .played-cards {
                min-height: 100px; /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®æœ€å°é«˜ã•ã‚’èª¿æ•´ */
            }
            
            .player-hand {
                min-height: 130px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <h1>ã‹ã‚ã„ã„å¤§å¯Œè±ªã‚²ãƒ¼ãƒ </h1>
    <div class="game-area">
        <div class="revolution-indicator">é©å‘½ä¸­!</div>
        
        <div class="player-info">
            <div class="player" id="player1-info">
                COM1<br>
                <div class="animal-icon" id="player1-icon"></div>
                <span id="player1-cards">13</span>æš
            </div>
            <div class="player" id="player2-info">
                COM2<br>
                <div class="animal-icon" id="player2-icon"></div>
                <span id="player2-cards">13</span>æš
            </div>
            <div class="player" id="player3-info">
                COM3<br>
                <div class="animal-icon" id="player3-icon"></div>
                <span id="player3-cards">13</span>æš
            </div>
            <div class="player" id="player0-info">
                ã‚ãªãŸ<br><span id="player0-cards">13</span>æš
            </div>
        </div>
        
        <div class="play-area">
            <div class="status-message" id="status-message">ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ï¼</div>
            <div class="played-cards" id="played-cards"></div>
        </div>
        
        <div class="player-hand" id="player-hand"></div>
        
        <div class="controls">
            <button class="btn" id="play-btn" disabled>ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™</button>
            <button class="btn pass-btn" id="pass-btn">ãƒ‘ã‚¹</button>
        </div>
        
        <div class="game-over" id="game-over">
            <h2>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
            <div class="results" id="results"></div>
            <button class="btn restart-btn" id="restart-btn">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>
    </div>

    <script>
// ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹
const gameState = {
    deck: [],
    players: [
        { id: 0, name: "ã‚ãªãŸ", cards: [], isHuman: true, rank: null },
        { id: 1, name: "COM1", cards: [], isHuman: false, rank: null, icon: "" },
        { id: 2, name: "COM2", cards: [], isHuman: false, rank: null, icon: "" },
        { id: 3, name: "COM3", cards: [], isHuman: false, rank: null, icon: "" }
    ],
    currentPlayerIndex: 0,
    playedCards: [],
    selectedCards: [],
    lastPlayedBy: null,
    passedPlayers: [],
    isRevolution: false,
    gameEnded: false,
    nextRankToAssign: 1
};

// ã‹ã‚ã„ã„å‹•ç‰©ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆ15ç¨®é¡ï¼‰
const animalIcons = [
    "ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¦", 
    "ğŸ¯", "ğŸ¦„", "ğŸ·", "ğŸ¦‹", "ğŸ¸"
];

// DOMè¦ç´ 
const playerHandElement = document.getElementById('player-hand');
const playedCardsElement = document.getElementById('played-cards');
const playButton = document.getElementById('play-btn');
const passButton = document.getElementById('pass-btn');
const statusMessage = document.getElementById('status-message');
const revolutionIndicator = document.querySelector('.revolution-indicator');
const gameOverElement = document.getElementById('game-over');
const resultsElement = document.getElementById('results');
const restartButton = document.getElementById('restart-btn');

// ã‚«ãƒ¼ãƒ‰ã®ã‚¹ãƒ¼ãƒˆï¼ˆãƒãƒ¼ã‚¯ï¼‰ã¨æ•°å­—
const suits = [
    { name: 'heart', symbol: 'â™¥', emoji: 'ğŸŒ¸' },
    { name: 'diamond', symbol: 'â™¦', emoji: 'ğŸŒŸ' },
    { name: 'club', symbol: 'â™£', emoji: 'ğŸ€' },
    { name: 'spade', symbol: 'â™ ', emoji: 'ğŸ¾' }
];

// ã‚«ãƒ¼ãƒ‰ã®ãƒ©ãƒ³ã‚¯ï¼ˆ2ãŒæœ€å¼·ã€æ¬¡ã«Aã€ãã®å¾ŒK,Q,J...ã¨ã„ã†é †ç•ªï¼‰
const ranks = [
    { value: 15, display: '2' },    // 2ã¯æœ€å¼·ãªã®ã§é«˜ã„å€¤
    { value: 14, display: 'A' },    // Aã¯2ã®æ¬¡ã«å¼·ã„
    { value: 13, display: 'K' },
    { value: 12, display: 'Q' },
    { value: 11, display: 'J' },
    { value: 10, display: '10' },
    { value: 9, display: '9' },
    { value: 8, display: '8' },     // 8ã‚’è¿½åŠ 
    { value: 7, display: '7' },
    { value: 6, display: '6' },
    { value: 5, display: '5' },
    { value: 4, display: '4' },
    { value: 3, display: '3' }
];

// ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰²ã‚Šå½“ã¦ã‚‹
function assignAnimalIcons() {
    // ä½¿ç”¨æ¸ˆã¿ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã®ã‚»ãƒƒãƒˆ
    const usedIcons = new Set();
    
    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰²ã‚Šå½“ã¦
    for (let i = 1; i < gameState.players.length; i++) {
        let randomIconIndex;
        let randomIcon;
        
        // ã¾ã ä½¿ã‚ã‚Œã¦ã„ãªã„ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸ã¶
        do {
            randomIconIndex = Math.floor(Math.random() * animalIcons.length);
            randomIcon = animalIcons[randomIconIndex];
        } while (usedIcons.has(randomIcon) && usedIcons.size < animalIcons.length);
        
        // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰²ã‚Šå½“ã¦
        gameState.players[i].icon = randomIcon;
        usedIcons.add(randomIcon);
        
        // UIã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
        const iconElement = document.getElementById(`player${i}-icon`);
        if (iconElement) {
            iconElement.textContent = randomIcon;
        }
    }
}

// ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–
function initializeGame() {
    // ãƒ‡ãƒƒã‚­ã®ä½œæˆ
    gameState.deck = [];
    for (const suit of suits) {
        for (const rank of ranks) {
            gameState.deck.push({
                suit: suit,
                rank: rank,
                id: `${suit.name}-${rank.value}`
            });
        }
    }
    
    // ãƒ‡ãƒƒã‚­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    shuffleDeck();
    
    // ã‚«ãƒ¼ãƒ‰ã‚’é…ã‚‹
    dealCards();
    
    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    gameState.currentPlayerIndex = 0;
    gameState.playedCards = [];
    gameState.selectedCards = [];
    gameState.lastPlayedBy = null;
    gameState.passedPlayers = [];
    gameState.isRevolution = false;
    gameState.gameEnded = false;
    gameState.nextRankToAssign = 1;
    
    // å‹•ç‰©ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰²ã‚Šå½“ã¦
    assignAnimalIcons();
    
    // UIã®æ›´æ–°
    updateUI();
    
    // æœ€åˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç•ªã‚’é–‹å§‹
    startTurn();
}

// ãƒ‡ãƒƒã‚­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
function shuffleDeck() {
    for (let i = gameState.deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [gameState.deck[i], gameState.deck[j]] = [gameState.deck[j], gameState.deck[i]];
    }
}

// ã‚«ãƒ¼ãƒ‰ã‚’é…ã‚‹
function dealCards() {
    for (const player of gameState.players) {
        player.cards = [];
        player.rank = null;
    }
    
    // å…¨å“¡ã«å‡ç­‰ã«é…ã‚‹
    let cardIndex = 0;
    const cardsPerPlayer = Math.floor(gameState.deck.length / gameState.players.length);
    
    for (let i = 0; i < cardsPerPlayer; i++) {
        for (let j = 0; j < gameState.players.length; j++) {
            gameState.players[j].cards.push(gameState.deck[cardIndex]);
            cardIndex++;
        }
    }
    
    // æ®‹ã‚Šã®ã‚«ãƒ¼ãƒ‰ã‚’é…ã‚‹
    while (cardIndex < gameState.deck.length) {
        gameState.players[cardIndex % gameState.players.length].cards.push(gameState.deck[cardIndex]);
        cardIndex++;
    }
    
    // ã‚«ãƒ¼ãƒ‰ã‚’å¼·ã•é †ã«ã‚½ãƒ¼ãƒˆ
    for (const player of gameState.players) {
        sortPlayerCards(player);
    }
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚½ãƒ¼ãƒˆ
function sortPlayerCards(player) {
    player.cards.sort((a, b) => {
        return gameState.isRevolution 
            ? a.rank.value - b.rank.value 
            : b.rank.value - a.rank.value;
    });
}

// UIæ›´æ–°
function updateUI() {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‚’è¡¨ç¤º
    updatePlayerHand();
    
    // å ´ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    updatePlayedCards();
    
    // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æƒ…å ±ã‚’æ›´æ–°
    updatePlayerInfo();
    
    // é©å‘½çŠ¶æ…‹ã®è¡¨ç¤º
    revolutionIndicator.classList.toggle('revolution-active', gameState.isRevolution);
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    updateButtons();
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­è¡¨ç¤º
function updatePlayerHand() {
    playerHandElement.innerHTML = '';
    
    const humanPlayer = gameState.players[0];
    
    humanPlayer.cards.forEach(card => {
        const isSelected = gameState.selectedCards.some(selectedCard => 
            selectedCard.id === card.id
        );
        
        const cardElement = document.createElement('div');
        cardElement.className = `card ${card.suit.name} ${isSelected ? 'selected' : ''}`;
        cardElement.dataset.cardId = card.id;
        
        const rankTopElement = document.createElement('div');
        rankTopElement.className = 'rank';
        rankTopElement.style.textAlign = 'left';
        rankTopElement.textContent = card.rank.display;
        
        const centerElement = document.createElement('div');
        centerElement.className = 'center-img';
        centerElement.textContent = card.suit.emoji;
        
        const rankBottomElement = document.createElement('div');
        rankBottomElement.className = 'rank';
        rankBottomElement.style.textAlign = 'right';
        rankBottomElement.textContent = card.rank.display;
        
        cardElement.appendChild(rankTopElement);
        cardElement.appendChild(centerElement);
        cardElement.appendChild(rankBottomElement);
        
        cardElement.addEventListener('click', () => {
            toggleCardSelection(card);
        });
        
        playerHandElement.appendChild(cardElement);
    });
}

// å ´ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
function updatePlayedCards() {
    playedCardsElement.innerHTML = '';
    
    if (gameState.playedCards.length === 0) return;
    
    gameState.playedCards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = `card ${card.suit.name}`;
        
        const rankTopElement = document.createElement('div');
        rankTopElement.className = 'rank';
        rankTopElement.style.textAlign = 'left';
        rankTopElement.textContent = card.rank.display;
        
        const centerElement = document.createElement('div');
        centerElement.className = 'center-img';
        centerElement.textContent = card.suit.emoji;
        
        const rankBottomElement = document.createElement('div');
        rankBottomElement.className = 'rank';
        rankBottomElement.style.textAlign = 'right';
        rankBottomElement.textContent = card.rank.display;
        
        cardElement.appendChild(rankTopElement);
        cardElement.appendChild(centerElement);
        cardElement.appendChild(rankBottomElement);
        
        playedCardsElement.appendChild(cardElement);
    });
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã®æ›´æ–°
function updatePlayerInfo() {
    for (let i = 0; i < gameState.players.length; i++) {
        const player = gameState.players[i];
        const infoElement = document.getElementById(`player${i}-info`);
        const cardCountElement = document.getElementById(`player${i}-cards`);
        
        // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        infoElement.classList.toggle('current-player', i === gameState.currentPlayerIndex);
        
        // ã‚«ãƒ¼ãƒ‰æšæ•°ã‚’æ›´æ–°
        cardCountElement.textContent = player.cards.length;
        
        // ãƒ©ãƒ³ã‚¯ãŒç¢ºå®šã—ã¦ã„ã‚Œã°è¡¨ç¤º
        if (player.rank !== null) {
            if (i === 0) {
                infoElement.innerHTML = `${player.name}<br>ï¼ˆ${getRankName(player.rank)}ï¼‰`;
            } else {
                const iconElement = document.getElementById(`player${i}-icon`);
                infoElement.innerHTML = `${player.name}<br>ï¼ˆ${getRankName(player.rank)}ï¼‰`;
                iconElement.textContent = player.icon;
            }
        }
    }
}

// ãƒ©ãƒ³ã‚¯åã‚’å–å¾—
function getRankName(rank) {
    switch (rank) {
        case 1: return 'å¤§å¯Œè±ª';
        case 2: return 'å¯Œè±ª';
        case 3: return 'è²§æ°‘';
        case 4: return 'å¤§è²§æ°‘';
        default: return '';
    }
}

// ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
function updateButtons() {
    const isHumanTurn = gameState.currentPlayerIndex === 0 && !gameState.gameEnded;
    
    // ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ãŠã‚‰ãšã€æœ‰åŠ¹ãªå‡ºã—æ–¹ã§ãªã„å ´åˆã¯ãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const isValidPlay = isValidCardSelection();
    playButton.disabled = !isHumanTurn || !isValidPlay;
    
    passButton.disabled = !isHumanTurn || gameState.lastPlayedBy === null;
}

// ã‚«ãƒ¼ãƒ‰ã®é¸æŠ/é¸æŠè§£é™¤
function toggleCardSelection(card) {
    const index = gameState.selectedCards.findIndex(c => c.id === card.id);
    
    if (index === -1) {
        // ã¾ã é¸æŠã•ã‚Œã¦ã„ãªã„ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¶å ´åˆã€
        // åŒã˜ãƒ©ãƒ³ã‚¯ã®ã‚«ãƒ¼ãƒ‰ã®ã¿é¸æŠå¯èƒ½
        if (gameState.selectedCards.length === 0 || 
            gameState.selectedCards[0].rank.value === card.rank.value) {
            gameState.selectedCards.push(card);
        }
    } else {
        // é¸æŠè§£é™¤
        gameState.selectedCards.splice(index, 1);
    }
    
    updateUI();
}

// é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
function isValidCardSelection() {
    if (gameState.selectedCards.length === 0) {
        return false;
    }
    
    // åŒã˜ãƒ©ãƒ³ã‚¯ã®ã‚«ãƒ¼ãƒ‰ã®ã¿é¸æŠå¯èƒ½
    const firstRank = gameState.selectedCards[0].rank.value;
    const allSameRank = gameState.selectedCards.every(card => card.rank.value === firstRank);
    
    if (!allSameRank) {
        return false;
    }
    
    // æœ€åˆã®ãƒ—ãƒ¬ã‚¤ã¾ãŸã¯å ´ãŒæµã‚ŒãŸå¾Œã®å ´åˆ
    if (gameState.lastPlayedBy === null || gameState.playedCards.length === 0) {
        return true;
    }
    
    // æšæ•°ãƒã‚§ãƒƒã‚¯
    if (gameState.selectedCards.length !== gameState.playedCards.length) {
        return false;
    }
    
    // å¼·ã•ãƒã‚§ãƒƒã‚¯
    const lastPlayedRank = gameState.playedCards[0].rank.value;
    const selectedRank = gameState.selectedCards[0].rank.value;
    
    if (gameState.isRevolution) {
        // é©å‘½ä¸­ã¯æ•°å­—ãŒå°ã•ã„æ–¹ãŒå¼·ã„
        return selectedRank < lastPlayedRank;
    } else {
        // é€šå¸¸ã¯æ•°å­—ãŒå¤§ãã„æ–¹ãŒå¼·ã„
        return selectedRank > lastPlayedRank;
    }
}

// ã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤
function playCards() {
    const currentPlayer = gameState.players[gameState.currentPlayerIndex];
    
    // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’å ´ã«å‡ºã™
    gameState.playedCards = [...gameState.selectedCards];
    
    // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‹ã‚‰å‰Šé™¤
    for (const card of gameState.selectedCards) {
        const index = currentPlayer.cards.findIndex(c => c.id === card.id);
        if (index !== -1) {
            currentPlayer.cards.splice(index, 1);
        }
    }
    
    // é©å‘½åˆ¤å®šï¼ˆ4æšä»¥ä¸Šã®ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ãŸå ´åˆã«é©å‘½ç™ºç”Ÿï¼‰
    if (gameState.selectedCards.length >= 4) {
        gameState.isRevolution = !gameState.isRevolution;
        statusMessage.textContent = `${currentPlayer.name}ãŒ${gameState.selectedCards.length}æšå‡ºã—ã¦é©å‘½ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼`;
        
        // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚«ãƒ¼ãƒ‰ã‚’æ–°ã—ã„ãƒ«ãƒ¼ãƒ«ã§ã‚½ãƒ¼ãƒˆ
        for (const player of gameState.players) {
            sortPlayerCards(player);
        }
    } else {
        statusMessage.textContent = `${currentPlayer.name}ãŒ${gameState.selectedCards[0].rank.display}ã‚’${gameState.selectedCards.length}æšå‡ºã—ã¾ã—ãŸ`;
    }
    
    // å‡ºã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¨˜éŒ²
    gameState.lastPlayedBy = gameState.currentPlayerIndex;
    
    // ãƒ‘ã‚¹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    gameState.passedPlayers = [];
    
    // é¸æŠã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    gameState.selectedCards = [];
    
    // UIã‚’æ›´æ–°
    updateUI();
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ãŒç©ºã«ãªã£ãŸã‹ç¢ºèª
    checkPlayerFinished();
    
    // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸
    nextPlayer();
}

// ãƒ‘ã‚¹ã®å‡¦ç†
// ãƒ‘ã‚¹ã®å‡¦ç†
function passPlay() {
    const currentPlayer = gameState.players[gameState.currentPlayerIndex];
    
    // ãƒ‘ã‚¹ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¨˜éŒ²
    gameState.passedPlayers.push(gameState.currentPlayerIndex);
    
    statusMessage.textContent = `${currentPlayer.name}ã¯ãƒ‘ã‚¹ã—ã¾ã—ãŸ`;
    
    // é¸æŠã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    gameState.selectedCards = [];
    
    // UIã‚’æ›´æ–°
    updateUI();
    
    // ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ‘ã‚¹ã—ãŸå ´åˆã¯å ´ã‚’æµã™
    const activePlayers = gameState.players.filter(p => p.cards.length > 0 && !gameState.passedPlayers.includes(p.id));
    if (activePlayers.length <= 1) {
        // ãƒ‘ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«é…å»¶å®Ÿè¡Œ
        setTimeout(() => {
            gameState.playedCards = [];
            gameState.passedPlayers = [];
            
            // æœ€å¾Œã«ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰é–‹å§‹
            if (gameState.lastPlayedBy !== null && gameState.players[gameState.lastPlayedBy].cards.length > 0) {
                gameState.currentPlayerIndex = gameState.lastPlayedBy;
                statusMessage.textContent = `å ´ãŒæµã‚Œã¾ã—ãŸã€‚${gameState.players[gameState.lastPlayedBy].name}ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚`;
            } else {
                // æ‰‹æœ­ãŒã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸€äººã‹ã‚‰
                const nextPlayerWithCards = gameState.players.findIndex(p => p.cards.length > 0);
                if (nextPlayerWithCards !== -1) {
                    gameState.currentPlayerIndex = nextPlayerWithCards;
                    statusMessage.textContent = `å ´ãŒæµã‚Œã¾ã—ãŸã€‚${gameState.players[nextPlayerWithCards].name}ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚`;
                }
            }
            
            gameState.lastPlayedBy = null;
            
            // UIã‚’æ›´æ–°ã—ã¦æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹
            updateUI();
            startTurn();
        }, 1000); // ãƒ‘ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«1ç§’å¾…ã¤
    } else {
        // ãƒ‘ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«é…å»¶å®Ÿè¡Œ
        setTimeout(() => {
            // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸
            nextPlayer();
        }, 1000); // ãƒ‘ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«1ç§’å¾…ã¤
    }
}
// æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸
function nextPlayer() {
    // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¢ã™
    let nextIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
    
    // æ‰‹æœ­ãŒãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—
    while (gameState.players[nextIndex].cards.length === 0 || 
          gameState.passedPlayers.includes(nextIndex)) {
        nextIndex = (nextIndex + 1) % gameState.players.length;
        
        // å…¨å“¡ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‚æ‰‹æœ­ãŒã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        if (nextIndex === gameState.currentPlayerIndex) {
            // å ´ã‚’æµã™
            gameState.playedCards = [];
            gameState.passedPlayers = [];
            
            // æœ€å¾Œã«ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰å†é–‹
            if (gameState.lastPlayedBy !== null && gameState.players[gameState.lastPlayedBy].cards.length > 0) {
                gameState.currentPlayerIndex = gameState.lastPlayedBy;
                statusMessage.textContent = `å ´ãŒæµã‚Œã¾ã—ãŸã€‚${gameState.players[gameState.lastPlayedBy].name}ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚`;
            } else {
                // ã¾ãŸã¯æ‰‹æœ­ãŒã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸€äººã‹ã‚‰
                const availablePlayer = gameState.players.findIndex(p => p.cards.length > 0);
                if (availablePlayer !== -1) {
                    gameState.currentPlayerIndex = availablePlayer;
                    statusMessage.textContent = `å ´ãŒæµã‚Œã¾ã—ãŸã€‚${gameState.players[availablePlayer].name}ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚`;
                } else {
                    // èª°ã‚‚æ‰‹æœ­ãŒãªã„å ´åˆã¯ã‚²ãƒ¼ãƒ çµ‚äº†
                    gameState.gameEnded = true;
                    endGame();
                    return;
                }
            }
            
            gameState.lastPlayedBy = null;
            
            // UIã‚’æ›´æ–°ã—ã¦æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹
            updateUI();
            startTurn();
            return;
        }
    }
    
    gameState.currentPlayerIndex = nextIndex;
    
    // UIã‚’æ›´æ–°
    updateUI();
    
    // ã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¦ã„ãªã‘ã‚Œã°æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹
    if (!gameState.gameEnded) {
        startTurn();
    }
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚«ãƒ¼ãƒ‰ã‚’å…¨ã¦å‡ºã—åˆ‡ã£ãŸã‹ç¢ºèª
function checkPlayerFinished() {
    const currentPlayer = gameState.players[gameState.currentPlayerIndex];
    
    if (currentPlayer.cards.length === 0) {
        // ãƒ©ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦
        currentPlayer.rank = gameState.nextRankToAssign++;
        
        // æ®‹ã‚Š1äººã«ãªã£ãŸã‚‰ã€ãã®äººã«æœ€å¾Œã®ãƒ©ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹
        const playersWithCards = gameState.players.filter(p => p.cards.length > 0);
        if (playersWithCards.length === 1) {
            playersWithCards[0].rank = gameState.nextRankToAssign;
            gameState.gameEnded = true;
            endGame();
        }
        
        // ã“ã“ã§æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
    }
}

// ã‚²ãƒ¼ãƒ ã®çµ‚äº†å‡¦ç†
function endGame() {
    // çµæœè¡¨ç¤º
    resultsElement.innerHTML = '';
    
    // ãƒ©ãƒ³ã‚¯ã§ã‚½ãƒ¼ãƒˆ
    const sortedPlayers = [...gameState.players].sort((a, b) => a.rank - b.rank);
    
    sortedPlayers.forEach(player => {
        const resultItem = document.createElement('div');
        resultItem.textContent = `${getRankName(player.rank)}: ${player.name} ${player.icon || ''}`;
        resultsElement.appendChild(resultItem);
    });
    
    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤º
    gameOverElement.classList.add('active');
}

// ã‚¿ãƒ¼ãƒ³é–‹å§‹
function startTurn() {
    const currentPlayer = gameState.players[gameState.currentPlayerIndex];
    
    // ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³
    if (currentPlayer.isHuman) {
        statusMessage.textContent = 'ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™';
        updateUI();
    } else {
        // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ã‚¿ãƒ¼ãƒ³
        statusMessage.textContent = `${currentPlayer.name}ã®ç•ªã§ã™...`;
        updateUI();
        
        setTimeout(() => {
            playComputerTurn();
        }, 1000);
    }
}

// ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ã‚¿ãƒ¼ãƒ³å‡¦ç†
function playComputerTurn() {
    const currentPlayer = gameState.players[gameState.currentPlayerIndex];
    
    // å ´ã«ã‚«ãƒ¼ãƒ‰ãŒãªã„ã€ã¾ãŸã¯æœ€å¾Œã«ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ãŸã®ãŒè‡ªåˆ†ã®å ´åˆ
    if (gameState.playedCards.length === 0 || gameState.lastPlayedBy === null) {
        // æœ€ã‚‚å¼±ã„ã‚«ãƒ¼ãƒ‰ã‚’1æšå‡ºã™
        const weakestCard = gameState.isRevolution 
            ? currentPlayer.cards[currentPlayer.cards.length - 1]
            : currentPlayer.cards[0];
        
        // åŒã˜ãƒ©ãƒ³ã‚¯ã®ã‚«ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦é¸ã¶ï¼ˆè¤‡æ•°æšå‡ºã—ï¼‰
        gameState.selectedCards = currentPlayer.cards.filter(
            card => card.rank.value === weakestCard.rank.value
        );
        
        playCards();
        return;
    }
    
    // å ´ã«å‡ºã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã¨åŒã˜æšæ•°ã§å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’æ¢ã™
    const lastPlayedRank = gameState.playedCards[0].rank.value;
    const cardsNeeded = gameState.playedCards.length;
    
    // ãƒ©ãƒ³ã‚¯åˆ¥ã«ã‚«ãƒ¼ãƒ‰ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const cardsByRank = {};
    for (const card of currentPlayer.cards) {
        if (!cardsByRank[card.rank.value]) {
            cardsByRank[card.rank.value] = [];
        }
        cardsByRank[card.rank.value].push(card);
    }
    
    // å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ã®å€™è£œã‚’æ¢ã™
    let candidateRanks = [];
    for (const rank in cardsByRank) {
        if (cardsByRank[rank].length >= cardsNeeded) {
            const rankValue = parseInt(rank);
            if (gameState.isRevolution) {
                // é©å‘½ä¸­ã¯å°ã•ã„æ–¹ãŒå¼·ã„
                if (rankValue < lastPlayedRank) {
                    candidateRanks.push(rankValue);
                }
            } else {
                // é€šå¸¸ã¯å¤§ãã„æ–¹ãŒå¼·ã„
                if (rankValue > lastPlayedRank) {
                    candidateRanks.push(rankValue);
                }
            }
        }
    }
    
    if (candidateRanks.length > 0) {
        // å€™è£œãŒã‚ã‚‹å ´åˆã€æœ€ã‚‚æœ‰åˆ©ãªã‚«ãƒ¼ãƒ‰ã‚’é¸ã¶
        // é©å‘½ä¸­ã¯å¤§ãã„æ•°å­—ã€é€šå¸¸æ™‚ã¯å°ã•ã„æ•°å­—ãŒæœ‰åˆ©
        candidateRanks.sort((a, b) => gameState.isRevolution ? a - b : b - a);
        const selectedRank = candidateRanks[0];
        
        // é¸æŠã—ãŸãƒ©ãƒ³ã‚¯ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰å¿…è¦ãªæšæ•°ã‚’é¸ã¶
        gameState.selectedCards = cardsByRank[selectedRank].slice(0, cardsNeeded);
        
        playCards();
    } else {
        // å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯ãƒ‘ã‚¹
        passPlay();
    }
}

// ãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
playButton.addEventListener('click', playCards);

// ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
passButton.addEventListener('click', passPlay);

// ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
restartButton.addEventListener('click', () => {
    gameOverElement.classList.remove('active');
    initializeGame();
});

// ã‚²ãƒ¼ãƒ é–‹å§‹
initializeGame();
    </script>
</body>
</html>
