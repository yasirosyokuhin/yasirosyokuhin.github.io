
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ビデオポーカー</title>
    <style>
body {
    font-family: 'Arial', sans-serif;
    text-align: center;
    background-color: #006400;
    color: white;
    margin: 0;
    padding: 10px;
    touch-action: manipulation;
    user-select: none;
}

#game-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 10px;
}

#info-panel {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 10px;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
}

#cards-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

.card {
    width: 120px;
    height: 180px;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    cursor: pointer;
    transition: transform 0.2s;
    transform-style: preserve-3d;
    perspective: 1000px;
}

.card.held {
    /* トランプは動かさず下に「ホールド」と表示する */
}

.card.flip {
    animation: flipCard 0.6s ease-out;
}

.card.new-card {
    animation: newCardAnimation 0.5s ease-out;
}

@keyframes flipCard {
    0% { transform: rotateY(0deg); }
    50% { transform: rotateY(90deg); }
    100% { transform: rotateY(0deg); }
}

@keyframes newCardAnimation {
    0% { transform: rotateY(90deg) scale(0.8); opacity: 0.5; }
    100% { transform: rotateY(0deg) scale(1); opacity: 1; }
}

.card-back {
    background-color: #0000AA;
    background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);
}

.card-suit {
    font-size: 60px;
    line-height: 1;
}

.card-value {
    font-size: 24px;
    font-weight: bold;
    position: absolute;
    top: 10px;
    left: 10px;
}

.card-value-bottom {
    font-size: 24px;
    font-weight: bold;
    position: absolute;
    bottom: 10px;
    right: 10px;
    transform: rotate(180deg);
}

.heart, .diamond {
    color: #FF0000;
}

.spade, .club {
    color: #000000;
}

.joker {
    color: #FF00FF;
}

.face-card {
    width: 80px;
    height: 80px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 34px;
}

.held-text {
    position: absolute;
    bottom: -35px; /* 間隔をさらに広げた */
    color: #FFD700;
    font-weight: bold;
    font-size: 18px; /* 少し大きくした */
    text-shadow: 1px 1px 2px black;
}

#buttons-container {
    display: flex;
    justify-content: center;
    gap: 15px; /* 間隔を広げた */
    margin: 35px 0 20px; /* ホールド表示との間隔を確保 */
    flex-wrap: wrap;
}

button {
    padding: 14px 24px; /* ボタンを大きくした */
    font-size: 16px;
    border: none;
    border-radius: 5px;
    background-color: #FFD700;
    color: #000;
    cursor: pointer;
    transition: background-color 0.3s;
}

button:hover {
    background-color: #FFC107;
}

button:disabled {
    background-color: #cccccc;
    color: #666666;
    cursor: not-allowed;
}

#result {
    margin-top: 15px;
    font-size: 24px;
    font-weight: bold;
    min-height: 30px;
}

#double-up-container {
    display: none;
    flex-direction: column;
    align-items: center;
    margin-top: 10px;
    padding: 20px;
    background: linear-gradient(135deg, #2c3e50, #4a235a);
    border-radius: 15px;
    max-width: 450px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 0 40px rgba(255, 215, 0, 0.2);
    border: 2px solid #d4af37;
    position: relative;
    overflow: hidden;
}

#double-up-container::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: 20px;
    animation: pulse 1.5s infinite alternate;
    pointer-events: none;
}

@keyframes pulse {
    0% { opacity: 0.6; transform: scale(1); }
    100% { opacity: 1; transform: scale(1.03); }
}

#double-up-container h3 {
    margin: 0 0 15px 0;
    color: #FFD700;
    font-size: 28px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    letter-spacing: 1px;
}

#dealer-card {
    margin: 15px 0;
    background-color: white;
    transform: scale(1.1);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.5);
}

/* 横並びのカード表示用 */
#cards-comparison {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 15px 0;
}

#double-up-options {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

#double-up-options button {
    padding: 12px 25px;
    font-weight: bold;
    background: linear-gradient(to bottom, #FFD700, #FFC107);
    border: 1px solid #d4af37;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: all 0.3s;
}

#double-up-options button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    background: linear-gradient(to bottom, #FFC107, #FFD700);
}

#paytable {
    margin-top: 20px;
    border-collapse: collapse;
    width: 100%;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
}

#paytable th, #paytable td {
    padding: 8px;
    border: 1px solid #444;
}

#paytable th {
    background-color: #333;
}

#win-amount {
    font-size: 28px;
    color: #FFD700;
    margin: 10px 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    font-weight: bold;
}

@media (max-width: 600px) {
    .card {
        width: 60px;
        height: 90px;
    }
    
    .card-suit {
        font-size: 30px;
    }
    
    .card-value, .card-value-bottom {
        font-size: 14px;
        top: 5px;
        left: 5px;
    }
    
    .card-value-bottom {
        bottom: 5px;
        right: 5px;
    }
    
    .held-text {
        bottom: -30px;
        font-size: 14px;
    }
    
    button {
        padding: 10px 16px;
        font-size: 14px;
    }
    
    .face-card {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
    
    #double-up-container h3 {
        font-size: 22px;
    }
    
    #win-amount {
        font-size: 22px;
    }
}

#message-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

#message-box {
    background-color: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    max-width: 80%;
}

#message-box h2 {
    color: #d4af37;
    margin-top: 0;
}

#message-box p {
    color: #333;
    font-size: 18px;
    margin-bottom: 20px;
}

#message-box button {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
    </style>
</head>
<body>
    <div id="game-container">
        <h1>ビデオポーカー</h1>
        
        <div id="info-panel">
            <div id="coins">コイン: <span id="coins-value">300</span></div>
            <div id="bet">ベット: 10コイン</div>
        </div>
        
        <div id="cards-container">
            <div class="card card-back" id="card-0"></div>
            <div class="card card-back" id="card-1"></div>
            <div class="card card-back" id="card-2"></div>
            <div class="card card-back" id="card-3"></div>
            <div class="card card-back" id="card-4"></div>
        </div>
        
        <div id="buttons-container">
            <button id="deal-btn">カードを配る</button>
            <button id="draw-btn" disabled>カードを交換</button>
        </div>
        
        <div id="result"></div>
        
        <div id="double-up-container">
            <h3>ダブルアップチャレンジ</h3>
            <div id="win-amount"></div>
            <div id="cards-comparison">
                <div class="card" id="dealer-card"></div>
                <!-- プレイヤーのカードがここに動的に追加されます -->
            </div>
            <div id="double-up-options">
                <button id="higher-btn">高い</button>
                <button id="lower-btn">低い</button>
                <button id="collect-btn">獲得する</button>
            </div>
        </div>
        
        <table id="paytable">
            <tr>
                <th>役</th>
                <th>配当</th>
            </tr>
            <tr>
                <td>ワンペア</td>
                <td>5</td>
            </tr>
            <tr>
                <td>ツーペア</td>
                <td>20</td>
            </tr>
            <tr>
                <td>スリーカード</td>
                <td>30</td>
            </tr>
            <tr>
                <td>ストレート</td>
                <td>50</td>
            </tr>
            <tr>
                <td>フラッシュ</td>
                <td>50</td>
            </tr>
            <tr>
                <td>フルハウス</td>
                <td>100</td>
            </tr>
            <tr>
                <td>フォーカード</td>
                <td>150</td>
            </tr>
            <tr>
                <td>ストレートフラッシュ</td>
                <td>250</td>
            </tr>
            <tr>
                <td>ファイブカード</td>
                <td>300</td>
            </tr>
            <tr>
                <td>ロイヤルストレートフラッシュ</td>
                <td>1000</td>
            </tr>
        </table>
    </div>
    
    <div id="message-overlay">
        <div id="message-box">
            <h2>おめでとうございます！</h2>
            <p>コインが1000枚を超えました！あなたはビデオポーカーの達人です！</p>
            <button id="continue-btn">続ける</button>
        </div>
    </div>

    <script>
        // ゲームの状態
        const gameState = {
            coins: 300,
            betAmount: 10,
            deck: [],
            currentHand: [],
            heldCards: [false, false, false, false, false],
            gamePhase: 'initial', // initial, deal, draw, result, doubleUp
            winAmount: 0,
            doubleUpAmount: 0,
            dealerCard: null,
            playerCard: null,
            goalReached: false,
            replacedCardIndices: [],
            pendingWin: false // 役が揃ったが獲得していない状態を管理
        };

        // DOM要素
        const dealBtn = document.getElementById('deal-btn');
        const drawBtn = document.getElementById('draw-btn');
        const resultDiv = document.getElementById('result');
        const coinsValue = document.getElementById('coins-value');
        const doubleUpContainer = document.getElementById('double-up-container');
        const winAmountDiv = document.getElementById('win-amount');
        const dealerCardDiv = document.getElementById('dealer-card');
        const cardsComparisonDiv = document.getElementById('cards-comparison');
        const higherBtn = document.getElementById('higher-btn');
        const lowerBtn = document.getElementById('lower-btn');
        const collectBtn = document.getElementById('collect-btn');
        const messageOverlay = document.getElementById('message-overlay');
        const continueBtn = document.getElementById('continue-btn');

        // カードのスート、値、特殊表示
        const suits = {
            'heart': { symbol: '♥', display: '♥', color: 'heart' },
            'diamond': { symbol: '♦', display: '♦', color: 'diamond' },
            'club': { symbol: '♣', display: '♣', color: 'club' },
            'spade': { symbol: '♠', display: '♠', color: 'spade' },
            'joker': { symbol: '🃏', display: '🃏', color: 'joker' }
        };

        const values = {
            'A': { value: 14, display: 'A' },
            '2': { value: 2, display: '2' },
            '3': { value: 3, display: '3' },
            '4': { value: 4, display: '4' },
            '5': { value: 5, display: '5' },
            '6': { value: 6, display: '6' },
            '7': { value: 7, display: '7' },
            '8': { value: 8, display: '8' },
            '9': { value: 9, display: '9' },
            '10': { value: 10, display: '10' },
            'J': { value: 11, display: 'J', face: '👨‍⚖️' },
            'Q': { value: 12, display: 'Q', face: '👸' },
            'K': { value: 13, display: 'K', face: '🤴' },
            'Joker': { value: 15, display: 'Joker' }
        };

        // 配当表
        const payouts = {
            'ロイヤルストレートフラッシュ': 1000,
            'ストレートフラッシュ': 250,
            'フォーカード': 150,
            'フルハウス': 100,
            'フラッシュ': 50,
            'ストレート': 50,
            'スリーカード': 30,
            'ツーペア': 20,
            'ワンペア': 5,
            'ファイブカード': 300
        };

        // ゲーム初期化
        function initGame() {
            updateCoinsDisplay();
            
            // カードクリックでホールド
            document.querySelectorAll('.card').forEach((card, index) => {
                card.addEventListener('click', () => {
                    if (gameState.gamePhase === 'deal') {
                        toggleHold(index);
                    }
                });
            });
            
            // ボタンイベント
            dealBtn.addEventListener('click', dealOrCollect);
            drawBtn.addEventListener('click', drawCards);
            higherBtn.addEventListener('click', () => doubleUp('higher'));
            lowerBtn.addEventListener('click', () => doubleUp('lower'));
            collectBtn.addEventListener('click', collectWinnings);
            continueBtn.addEventListener('click', () => {
                messageOverlay.style.display = 'none';
            });
        }

        // カードを配るまたは獲得する
        function dealOrCollect() {
    if (gameState.pendingWin) {
        // 勝利金がある場合は獲得する
        gameState.coins += gameState.winAmount;
        updateCoinsDisplay();
        
        gameState.pendingWin = false;
        // ダブルアップの欄を閉じる
        doubleUpContainer.style.display = 'none';
        // 修正点: 獲得メッセージを表示せず、すぐに次のゲームへ進む
        dealCards();
        
        // 1000コイン以上でゴール達成
        if (gameState.coins >= 1000 && !gameState.goalReached) {
            gameState.goalReached = true;
            messageOverlay.style.display = 'flex';
        }
    } else {
        // 通常のディール処理
        dealCards();
    }
}

        // デッキを作成してシャッフル
        function createDeck() {
            const deck = [];
            
            // 通常のカードを追加
            Object.keys(suits).forEach(suit => {
                if (suit !== 'joker') {
                    Object.keys(values).forEach(value => {
                        if (value !== 'Joker') {
                            deck.push({
                                suit: suit,
                                value: value,
                                numericValue: values[value].value,
                                display: values[value].display,
                                suitDisplay: suits[suit].display,
                                color: suits[suit].color,
                                face: values[value].face || null
                            });
                        }
                    });
                }
            });
            
            // ジョーカーを1枚追加
            deck.push({
                suit: 'joker',
                value: 'Joker',
                numericValue: values['Joker'].value,
                display: 'Joker',
                suitDisplay: suits['joker'].display,
                color: suits['joker'].color,
                face: null
            });
            
            // デッキをシャッフル
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            return deck;
        }

        // コインの表示を更新
        function updateCoinsDisplay() {
            coinsValue.textContent = gameState.coins;
        }

        // カードを配る
        function dealCards() {
    // ダブルアップの欄を閉じる
    doubleUpContainer.style.display = 'none';
    
    // コインが足りなければ何もしない
    if (gameState.coins < gameState.betAmount) {
        resultDiv.textContent = "コインが足りません！";
        return;
    }
    
    // コインを減らす
    gameState.coins -= gameState.betAmount;
    updateCoinsDisplay();
    
    // デッキを新しく作成
    gameState.deck = createDeck();
    gameState.currentHand = [];
    gameState.heldCards = [false, false, false, false, false];
    gameState.replacedCardIndices = [];
    gameState.pendingWin = false;
    
    // カードを裏向きに戻す
    document.querySelectorAll('.card').forEach(card => {
        card.className = 'card card-back';
        card.innerHTML = '';
    });

    // カードをフリップするアニメーション
    setTimeout(() => {
        // 5枚のカードを配る
        for (let i = 0; i < 5; i++) {
            gameState.currentHand.push(gameState.deck.pop());
        }
        
        // カードにフリップアニメーションを適用してから表示
        for (let i = 0; i < 5; i++) {
            const cardElement = document.getElementById(`card-${i}`);
            cardElement.classList.add('flip');
            
            // アニメーション終了後にクラスを削除
            cardElement.addEventListener('animationend', function handler() {
                cardElement.classList.remove('flip');
                cardElement.removeEventListener('animationend', handler);
            });
        }
        
        // カードを表示
        renderHand();
        
        // ゲームフェーズを更新
        gameState.gamePhase = 'deal';
        
        // ボタンの状態を更新
        dealBtn.disabled = true;
        drawBtn.disabled = false;
        
        // 結果をクリア
        resultDiv.textContent = "";
    }, 300); // 少し遅延させてアニメーションを目立たせる
}

        // カードを交換
        function drawCards() {
            // 交換するカードのインデックスを記録
            gameState.replacedCardIndices = [];
            for (let i = 0; i < 5; i++) {
                if (!gameState.heldCards[i]) {
                    gameState.replacedCardIndices.push(i);
                }
            }
            
            // 交換するカードにフリップアニメーションを追加
            const flipPromises = [];
            
            for (let i = 0; i < 5; i++) {
                if (!gameState.heldCards[i]) {
                    const cardElement = document.getElementById(`card-${i}`);
                    cardElement.classList.add('flip');
                    
                    // プロミスを作成してアニメーション完了を監視
                    const promise = new Promise(resolve => {
                        setTimeout(() => {
                            // アニメーション中間点（裏向き）でカードを交換
                            gameState.currentHand[i] = gameState.deck.pop();
                            resolve();
                        }, 300); // アニメーションの半分の時間
                    });
                    
                    flipPromises.push(promise);
                    
                    // アニメーション終了後にクラスを削除
                    cardElement.addEventListener('animationend', function handler() {
                        cardElement.classList.remove('flip');
                        cardElement.removeEventListener('animationend', handler);
                    });
                }
            }
            
            // すべてのアニメーション中間点を待ってから処理を続行
            Promise.all(flipPromises).then(() => {
                // カードを表示
                renderHand();
                
                // 役を評価
                evaluateHand();
                
                // ゲームフェーズを更新
                gameState.gamePhase = 'result';
                
                // ボタンの状態を更新
                dealBtn.disabled = false;
                drawBtn.disabled = true;
            });
        }

        // 手札を描画
        function renderHand() {
            for (let i = 0; i < 5; i++) {
                const cardElement = document.getElementById(`card-${i}`);
                cardElement.className = 'card';
                
                // 新しく交換されたカードにアニメーション効果を追加
                if (gameState.gamePhase === 'result' && gameState.replacedCardIndices.includes(i)) {
                    cardElement.classList.add('new-card');
                }
                
                cardElement.innerHTML = '';
                
                if (gameState.currentHand[i]) {
                    const card = gameState.currentHand[i];
                    
                    if (card.suit === 'joker') {
                        const suitElement = document.createElement('div');
                        suitElement.className = `card-suit ${card.color}`;
                        suitElement.textContent = card.suitDisplay;
                        cardElement.appendChild(suitElement);
                        
                        const valueElement = document.createElement('div');
                        valueElement.className = `card-value ${card.color}`;
                        valueElement.textContent = card.display;
                        cardElement.appendChild(valueElement);
                    } else {
                        const valueElement = document.createElement('div');
                        valueElement.className = `card-value ${card.color}`;
                        valueElement.textContent = card.display;
                        cardElement.appendChild(valueElement);
                        
                        // K, Q, J には絵柄を追加
                        if (card.face) {
                            const faceElement = document.createElement('div');
                            faceElement.className = 'face-card';
                            faceElement.textContent = card.face;
                            cardElement.appendChild(faceElement);
                        } else {
                            const suitElement = document.createElement('div');
                            suitElement.className = `card-suit ${card.color}`;
                            suitElement.textContent = card.suitDisplay;
                            cardElement.appendChild(suitElement);
                        }
                        
                        const valueBottomElement = document.createElement('div');
                        valueBottomElement.className = `card-value-bottom ${card.color}`;
                        valueBottomElement.textContent = card.display;
                        cardElement.appendChild(valueBottomElement);
                    }
                    
                    if (gameState.heldCards[i] && gameState.gamePhase === 'deal') {
                        // トランプの下にホールドと表示
                        const heldText = document.createElement('div');
                        heldText.className = 'held-text';
                        heldText.textContent = 'ホールド';
                        cardElement.appendChild(heldText);
                    }
                } else {
                    cardElement.className = 'card card-back';
                }
            }
        }

        // ホールドを切り替える
        function toggleHold(index) {
            if (gameState.gamePhase === 'deal') {
                gameState.heldCards[index] = !gameState.heldCards[index];
                renderHand();
            }
        }

        // 役を評価する
        function evaluateHand() {
            // ジョーカー補完の前に役を確認
            const handResult = checkHand(gameState.currentHand);
            
            resultDiv.textContent = handResult.handName;
            
            if (handResult.payout > 0) {
                // 配当を設定
                gameState.winAmount = handResult.payout;
                resultDiv.textContent += ` - ${gameState.winAmount}コイン`;
                
                // 勝利金額を保留状態にする
                gameState.pendingWin = true;
                
                // ダブルアップ可能な場合
                gameState.doubleUpAmount = gameState.winAmount;
                prepareDoubleUp();
            } else {
                resetGameForNextDeal();
            }
        }

        // 役を確認する関数
        function checkHand(hand) {
            // ジョーカーのインデックスを見つける
            const jokerIndices = hand.map((card, index) => 
                card.suit === 'joker' ? index : -1).filter(index => index !== -1);
            
            // ジョーカーがある場合の最適な役を見つける
            if (jokerIndices.length > 0) {
                return findBestHandWithJokers(hand, jokerIndices);
            }
            
            // ジョーカーがない場合は通常の役判定
            return evaluateHandNormal(hand);
        }

        // ジョーカーを考慮して最適な役を見つける関数
        function findBestHandWithJokers(hand, jokerIndices) {
            // すべての可能な組み合わせを試す（単純化のため）
            let bestHand = { handName: 'ノーペア', payout: 0 };
            
            // ジョーカーを各スートと数字で置き換えてみる
            Object.keys(suits).forEach(suit => {
                if (suit !== 'joker') {
                    Object.keys(values).forEach(value => {
                        if (value !== 'Joker') {
                            const tempHand = [...hand];
                            jokerIndices.forEach(idx => {
                                tempHand[idx] = {
                                    suit: suit,
                                    value: value,
                                    numericValue: values[value].value,
                                    display: values[value].display,
                                    suitDisplay: suits[suit].display,
                                    color: suits[suit].color,
                                    face: values[value].face || null
                                };
                            });
                            
                            const result = evaluateHandNormal(tempHand);
                            if (result.payout > bestHand.payout) {
                                bestHand = result;
                            }
                        }
                    });
                }
            });
            
            return bestHand;
        }

        // 通常の役判定関数
        function evaluateHandNormal(hand) {
            // 役の判定用に数値とスートの配列を作成
            const values = hand.map(card => card.numericValue);
            const suits = hand.map(card => card.suit);
            
            // 各数値の出現回数をカウント
            const valueCounts = {};
            values.forEach(value => {
                valueCounts[value] = (valueCounts[value] || 0) + 1;
            });
            
            // 出現回数の配列
            const counts = Object.values(valueCounts);
            
            // 同じスートかどうか
            const isFlush = suits.every(suit => suit === suits[0]);
            
            // ソートした値
            const sortedValues = [...values].sort((a, b) => a - b);
            
            // ストレートかどうか（Aは1としても14としても扱う）
            let isStraight = true;
            for (let i = 1; i < sortedValues.length; i++) {
                if (sortedValues[i] !== sortedValues[i-1] + 1) {
                    isStraight = false;
                    break;
                }
            }
            
            // A-5のストレートの特別ケース
            if (!isStraight && sortedValues[0] === 2 && sortedValues[4] === 14) {
                const tempValues = [1, ...sortedValues.slice(0, 4)];
                isStraight = true;
                for (let i = 1; i < tempValues.length; i++) {
                    if (tempValues[i] !== tempValues[i-1] + 1) {
                        isStraight = false;
                        break;
                    }
                }
            }
            
            // ロイヤルストレートフラッシュ（10, J, Q, K, A の同じスート）
            const isRoyal = JSON.stringify(sortedValues.sort()) === JSON.stringify([10, 11, 12, 13, 14]);
            
            // ファイブカード (5枚同じ数字、ジョーカー使用時のみ可能)
            if (counts.includes(5)) {
                return { handName: 'ファイブカード', payout: payouts['ファイブカード'] };
            }
            
            // ロイヤルストレートフラッシュ
            if (isFlush && isStraight && isRoyal) {
                return { handName: 'ロイヤルストレートフラッシュ', payout: payouts['ロイヤルストレートフラッシュ'] };
            }
            
            // ストレートフラッシュ
            if (isFlush && isStraight) {
                return { handName: 'ストレートフラッシュ', payout: payouts['ストレートフラッシュ'] };
            }
            
            // フォーカード
            if (counts.includes(4)) {
                return { handName: 'フォーカード', payout: payouts['フォーカード'] };
            }
            
            // フルハウス
            if (counts.includes(3) && counts.includes(2)) {
                return { handName: 'フルハウス', payout: payouts['フルハウス'] };
            }
            
            // フラッシュ
            if (isFlush) {
                return { handName: 'フラッシュ', payout: payouts['フラッシュ'] };
            }
            
            // ストレート
            if (isStraight) {
                return { handName: 'ストレート', payout: payouts['ストレート'] };
            }
            
            // スリーカード
            if (counts.includes(3)) {
                return { handName: 'スリーカード', payout: payouts['スリーカード'] };
            }
            
            // ツーペア
            if (counts.filter(count => count === 2).length === 2) {
                return { handName: 'ツーペア', payout: payouts['ツーペア'] };
            }
            
            // ワンペア
            if (counts.includes(2)) {
                return { handName: 'ワンペア', payout: payouts['ワンペア'] };
            }
            
            // ノーペア
            return { handName: 'ノーペア', payout: 0 };
        }

        // ダブルアップの準備
        function prepareDoubleUp() {
            gameState.gamePhase = 'doubleUp';
            
            // 新しいデッキを用意
            gameState.deck = createDeck();
            
            // ディーラーのカードを引く
            gameState.dealerCard = gameState.deck.pop();
            
            // ディーラーのカードを表示
            renderDealerCard();
            
            // カード比較エリアを初期化（プレイヤーカードがある場合は削除）
            const existingPlayerCard = document.getElementById('player-card');
            if (existingPlayerCard) {
                existingPlayerCard.remove();
            }
            
            // 獲得金額を表示
            winAmountDiv.textContent = `獲得コイン: ${gameState.doubleUpAmount}`;
            
            // ダブルアップコンテナを表示
            doubleUpContainer.style.display = 'flex';
        }

        // ディーラーのカードを描画
        function renderDealerCard() {
            dealerCardDiv.innerHTML = '';
            dealerCardDiv.className = 'card'; // 裏面クラスを削除し、白い背景にする
            
            const card = gameState.dealerCard;
            
            if (card.suit === 'joker') {
                const suitElement = document.createElement('div');
                suitElement.className = `card-suit ${card.color}`;
                suitElement.textContent = card.suitDisplay;
                dealerCardDiv.appendChild(suitElement);
                
                const valueElement = document.createElement('div');
                valueElement.className = `card-value ${card.color}`;
                valueElement.textContent = card.display;
                dealerCardDiv.appendChild(valueElement);
            } else {
                const valueElement = document.createElement('div');
                valueElement.className = `card-value ${card.color}`;
                valueElement.textContent = card.display;
                dealerCardDiv.appendChild(valueElement);
                
                // K, Q, J には絵柄を追加
                if (card.face) {
                    const faceElement = document.createElement('div');
                    faceElement.className = 'face-card';
                    faceElement.textContent = card.face;
                    dealerCardDiv.appendChild(faceElement);
                } else {
                    const suitElement = document.createElement('div');
                    suitElement.className = `card-suit ${card.color}`;
                    suitElement.textContent = card.suitDisplay;
                    dealerCardDiv.appendChild(suitElement);
                }
                
                const valueBottomElement = document.createElement('div');
                valueBottomElement.className = `card-value-bottom ${card.color}`;
                valueBottomElement.textContent = card.display;
                dealerCardDiv.appendChild(valueBottomElement);
            }
        }

        // ダブルアップ
        function doubleUp(choice) {
            // プレイヤーのカードを引く
            gameState.playerCard = gameState.deck.pop();
            
            // プレイヤーのカードを表示（アニメーション付き）
            const playerCardDiv = document.createElement('div');
            playerCardDiv.className = 'card flip';
            playerCardDiv.id = 'player-card';
            
            // 横に並べるためにディーラーカードの後ろではなく cards-comparison の中に追加
            cardsComparisonDiv.appendChild(playerCardDiv);
            
            setTimeout(() => {
                // カードの情報を設定
                const card = gameState.playerCard;
                
                if (card.suit === 'joker') {
                    const suitElement = document.createElement('div');
                    suitElement.className = `card-suit ${card.color}`;
                    suitElement.textContent = card.suitDisplay;
                    playerCardDiv.appendChild(suitElement);
                    
                    const valueElement = document.createElement('div');
                    valueElement.className = `card-value ${card.color}`;
                    valueElement.textContent = card.display;
                    playerCardDiv.appendChild(valueElement);
                } else {
                    const valueElement = document.createElement('div');
                    valueElement.className = `card-value ${card.color}`;
                    valueElement.textContent = card.display;
                    playerCardDiv.appendChild(valueElement);
                    
                    // K, Q, J には絵柄を追加
                    if (card.face) {
                        const faceElement = document.createElement('div');
                        faceElement.className = 'face-card';
                        faceElement.textContent = card.face;
                        playerCardDiv.appendChild(faceElement);
                    } else {
                        const suitElement = document.createElement('div');
                        suitElement.className = `card-suit ${card.color}`;
                        suitElement.textContent = card.suitDisplay;
                        playerCardDiv.appendChild(suitElement);
                    }
                    
                    const valueBottomElement = document.createElement('div');
                    valueBottomElement.className = `card-value-bottom ${card.color}`;
                    valueBottomElement.textContent = card.display;
                    playerCardDiv.appendChild(valueBottomElement);
                }
                
                // アニメーション終了時のイベントリスナーを追加
                playerCardDiv.addEventListener('animationend', function handler() {
                    playerCardDiv.classList.remove('flip');
                    playerCardDiv.removeEventListener('animationend', handler);
                    
                    // 勝敗判定
                    let result;
                    
                    // ディーラーとプレイヤーの数値を比較
                    const dealerValue = gameState.dealerCard.numericValue;
                    const playerValue = gameState.playerCard.numericValue;
                    
                    if (dealerValue === playerValue) {
                        // 引き分けの場合は再挑戦
                        result = 'draw';
                        resultDiv.textContent = "引き分け - もう一度チャレンジ！";
                        
                        // 少し待ってから新しいディーラーカードを引いて表示
                        setTimeout(() => {
                            // 古いプレイヤーカードを削除
                            playerCardDiv.remove();
                            
                            // 新しいディーラーカードを引いて表示（アニメーション付き）
                            gameState.dealerCard = gameState.deck.pop();
                            dealerCardDiv.classList.add('flip');
                            
                            setTimeout(() => {
                                renderDealerCard();
                                
                                dealerCardDiv.addEventListener('animationend', function animEnd() {
                                    dealerCardDiv.classList.remove('flip');
                                    dealerCardDiv.removeEventListener('animationend', animEnd);
                                });
                            }, 300);
                        }, 1000);
                        
                        return;
                    } else if ((choice === 'higher' && playerValue > dealerValue) || 
                               (choice === 'lower' && playerValue < dealerValue)) {
                        // 勝ち
                        result = 'win';
                        gameState.doubleUpAmount *= 2;
                        resultDiv.textContent = `勝ち！ ${gameState.doubleUpAmount}コイン！`;
                        winAmountDiv.textContent = `獲得コイン: ${gameState.doubleUpAmount}`;
                        
                        // 少し待ってから新しいディーラーカードを引く
                        setTimeout(() => {
                            // 古いプレイヤーカードを削除
                            playerCardDiv.remove();
                            
                            // 新しいディーラーカードを引いて表示（アニメーション付き）
                            gameState.dealerCard = gameState.deck.pop();
                            dealerCardDiv.classList.add('flip');
                            
                            setTimeout(() => {
                                renderDealerCard();
                                
                                dealerCardDiv.addEventListener('animationend', function animEnd() {
                                    dealerCardDiv.classList.remove('flip');
                                    dealerCardDiv.removeEventListener('animationend', animEnd);
                                });
                            }, 300);
                        }, 1000);
                    } else {
                        // 負け
                        result = 'lose';
                        gameState.doubleUpAmount = 0;
                        gameState.pendingWin = false; // 勝利金をリセット
                        resultDiv.textContent = "負け！ コインを失いました。";
                        
                        // ダブルアップを終了
                        setTimeout(() => {
                            playerCardDiv.remove();
                            doubleUpContainer.style.display = 'none';
                            resetGameForNextDeal();
                        }, 1500);
                    }
                });
            }, 300); // フリップアニメーションの中間点
        }

        // 獲得金額を受け取る
        function collectWinnings() {
            // コインを加算
            gameState.coins += gameState.doubleUpAmount;
            updateCoinsDisplay();
            
            // 勝利金をリセット
            gameState.pendingWin = false;
            
            // ダブルアップを終了
            doubleUpContainer.style.display = 'none';
            
            // 修正点: 獲得メッセージを表示せず、すぐに次のゲームを開始
            dealCards();
            
            // 1000コイン以上でゴール達成
            if (gameState.coins >= 1000 && !gameState.goalReached) {
                gameState.goalReached = true;
                messageOverlay.style.display = 'flex';
            }
        }

        // 次のディールのためにゲームをリセット
        function resetGameForNextDeal() {
            gameState.gamePhase = 'initial';
            dealBtn.disabled = false;
            drawBtn.disabled = true;
        }

        // ゲーム開始
        initGame();
    </script>
</body>
</html>
